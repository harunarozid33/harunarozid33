<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kasir - Toko Material</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; font-family: 'Inter', sans-serif; }
    .navbar { box-shadow: 0 2px 4px rgba(0,0,0,.1); }
    .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,.05); }
    .total-display { font-size: 2rem; font-weight: bold; color: #0d6efd; }
    .btn-remove { color: #dc3545; cursor: pointer; }
    .btn-remove:hover { color: #a71d2a; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
  <div class="container">
    <a class="navbar-brand fw-bold" href="#"><i class="fas fa-tools me-2"></i>Toko Material</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-home me-1"></i> Dashboard</a></li>
        <li class="nav-item"><a class="nav-link active" href="#"><i class="fas fa-shopping-cart me-1"></i> Kasir</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-box me-1"></i> Produk</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container">
  <div class="row g-4">
    <div class="col-lg-4">
      <div class="card p-4">
        <h5 class="card-title mb-4 fw-bold text-secondary">Input Transaksi</h5>
        
        <div class="mb-3">
          <label class="form-label fw-semibold">Pilih Pelanggan</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-user"></i></span>
            <select id="pelanggan" class="form-select"></select>
          </div>
          <div class="form-text">Atau ketik nama pelanggan baru di bawah untuk menambahkan sekaligus menyimpan transaksi.</div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Nama Pelanggan Baru (opsional)</label>
          <input type="text" id="pelanggan_baru" class="form-control" placeholder="Contoh: Budi Santoso" />
        </div>
        <div class="mb-3">
          <label class="form-label fw-semibold">Alamat Pelanggan</label>
          <input type="text" id="pelanggan_alamat" class="form-control" placeholder="Contoh: Jl. Merdeka No.1" />
        </div>
        <div class="mb-3">
          <label class="form-label fw-semibold">No. HP Pelanggan</label>
          <input type="tel" id="pelanggan_nohp" class="form-control" placeholder="0812xxxx" />
        </div>

        <hr>

        <div class="mb-3">
          <label class="form-label fw-semibold">Pilih Produk</label>
          <select id="produk" class="form-select mb-2" onchange="updateMaxQty()"></select>
          <div id="produkStatus" class="form-text text-muted small mb-2">Memuat produk...</div>
          <div class="row g-2">
            <div class="col-8">
              <input type="number" id="qty" class="form-control" value="1" min="1" placeholder="Qty">
            </div>
            <div class="col-4">
              <button onclick="tambahItem()" class="btn btn-primary w-100">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card p-4 h-100">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h5 class="card-title mb-0 fw-bold text-secondary">Keranjang Belanja</h5>
          <span class="badge bg-info text-dark" id="itemCount">0 Items</span>
        </div>

        <div class="table-responsive" style="min-height: 200px;">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Produk</th>
                <th>Harga</th>
                <th width="100">Qty</th>
                <th>Subtotal</th>
                <th width="50"></th>
              </tr>
            </thead>
            <tbody id="keranjang">
              </tbody>
          </table>
        </div>

        <div class="mt-auto border-top pt-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">Total Pembayaran:</span>
            <span class="total-display" id="total">Rp 0</span>
          </div>
          <button onclick="simpanTransaksi()" class="btn btn-success btn-lg w-100 fw-bold">
            <i class="fas fa-check-circle me-2"></i>SELESAIKAN TRANSAKSI
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const API = "http://localhost/toko-material/api/api.php/records";
let cart = [];

function formatRupiah(n) {
  return 'Rp ' + Number(n).toLocaleString('id-ID');
}

function formatLocalDatetime(d = new Date()) {
  const pad = n => String(n).padStart(2, '0');
  return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

function loadProduk() {
  const select = document.getElementById("produk");
  const status = document.getElementById('produkStatus');
  select.innerHTML = '<option value="" disabled selected>Memuat produk...</option>';
  select.disabled = true;
  if (status) status.innerText = 'Memuat produk...';

  fetch(API + "/produk")
    .then(res => res.json())
    .then(data => {
      select.innerHTML = '<option value="" disabled selected>-- Pilih Barang --</option>';
      if (!data || !data.records || data.records.length === 0) {
        select.innerHTML = '<option value="" disabled selected>Tidak ada produk</option>';
        if (status) status.innerText = 'Tidak ada produk tersedia.';
        select.disabled = true;
        const btn = document.querySelector('button[onclick="tambahItem()"]'); if (btn) btn.disabled = true;
        return;
      }

      data.records.forEach(p => {
        let disabled = p.stok <= 0 ? 'disabled' : '';
        select.innerHTML += `<option value="${p.id}" data-harga="${p.harga}" data-stok="${p.stok}" ${disabled}>${p.nama_produk} (Stok: ${p.stok})</option>`;
      });

      select.disabled = false;
      if (status) status.innerText = '';
      const btn = document.querySelector('button[onclick="tambahItem()"]'); if (btn) btn.disabled = false;
      // set qty max according to first product
      updateMaxQty();
    })
    .catch(err => {
      console.error('Gagal loadProduk', err);
      select.innerHTML = '<option value="" disabled selected>Gagal memuat produk</option>';
      if (status) status.innerText = 'Gagal memuat produk. Periksa koneksi atau API.';
      select.disabled = true;
      const btn = document.querySelector('button[onclick="tambahItem()"]'); if (btn) btn.disabled = true;
    });
}

function loadPelanggan() {
  return fetch(API + "/pelanggan")
    .then(res => res.json())
    .then(data => {
      let select = document.getElementById("pelanggan");
      select.innerHTML = "";
      data.records.forEach(p => {
        select.innerHTML += `<option value="${p.id}">${p.nama_pelanggan}</option>`;
      });
      return data;
    });
}

function updateMaxQty() {
  const produkSelect = document.getElementById('produk');
  const qtyEl = document.getElementById('qty');
  if (!produkSelect || !qtyEl) return;
  const option = produkSelect.options[produkSelect.selectedIndex];
  if (!option) {
    qtyEl.removeAttribute('max');
    return;
  }
  const stok = parseInt(option.dataset.stok) || 0;
  qtyEl.max = stok;
  if (parseInt(qtyEl.value) > stok) qtyEl.value = stok > 0 ? stok : 1;
}

function tambahItem() {
  let produkSelect = document.getElementById("produk");
  if(!produkSelect.value) return alert("Pilih produk dulu!");

  let id_produk = produkSelect.value;
  let option = produkSelect.options[produkSelect.selectedIndex];
  let nama_produk = option.text.split(' (Stok:')[0].trim();
  let harga = parseFloat(option.dataset.harga);
  let stok = parseInt(option.dataset.stok) || 0;
  let qty = parseInt(document.getElementById("qty").value);

  if (qty <= 0 || qty > stok) return alert("Qty tidak valid atau stok tidak cukup!");

  // Cek jika produk sudah ada di keranjang
  let existing = cart.find(c => c.id_produk === id_produk);
  if(existing) {
    if(existing.qty + qty > stok) return alert("Total Qty melebihi stok!");
    existing.qty += qty;
    existing.subtotal = existing.qty * existing.harga;
  } else {
    cart.push({ id_produk, nama_produk, harga, qty, subtotal: harga * qty, stok });
  }

  renderCart();
}

function hapusItem(index) {
    cart.splice(index, 1);
    renderCart();
}

function renderCart() {
  let tbody = document.getElementById("keranjang");
  let total = 0;
  tbody.innerHTML = "";

  cart.forEach((item, index) => {
    total += item.subtotal;
    tbody.innerHTML += `
      <tr>
        <td class="fw-semibold">${item.nama_produk}</td>
        <td>${formatRupiah(item.harga)}</td>
        <td><span class="badge bg-secondary px-3 py-2">${item.qty}</span></td>
        <td class="fw-bold text-end">${formatRupiah(item.subtotal)}</td>
        <td><i class="fas fa-trash-alt btn-remove" onclick="hapusItem(${index})"></i></td>
      </tr>`;
  });

  document.getElementById("total").innerText = formatRupiah(total);
  document.getElementById("itemCount").innerText = cart.length + " Items";
}

function createPelangganIfNeeded() {
  let namaBaru = document.getElementById('pelanggan_baru').value.trim();
  let alamat = (document.getElementById('pelanggan_alamat') || {}).value || '';
  alamat = alamat.trim();
  let nohp = (document.getElementById('pelanggan_nohp') || {}).value || '';
  nohp = nohp.trim();

  if (!namaBaru) return Promise.resolve(document.getElementById('pelanggan').value || null);

  // basic phone validation (optional field)
  if (nohp && !/^[0-9+\-() ]+$/.test(nohp)) {
    alert('Format No. HP tidak valid. Gunakan angka, spasi atau tanda + - ( )');
    return Promise.reject('Invalid phone');
  }

  const payload = { nama_pelanggan: namaBaru };
  if (alamat) payload.alamat = alamat;
  if (nohp) payload.no_hp = nohp;

  return fetch(API + "/pelanggan", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(result => {
    // Try to get inserted id from common response shapes
    let newId = null;
    if (typeof result === 'number') newId = result;
    if (!newId && result) {
      newId = result.id || (result.record && result.record.id) || result.insert_id || result.insertId || null;
    }
    if (!newId) {
      // fallback: query by name and phone (safer when duplicates exist)
      let filter = 'nama_pelanggan,eq,' + encodeURIComponent(namaBaru);
      if (nohp) filter += '&filter=no_hp,eq,' + encodeURIComponent(nohp);
      return fetch(API + "/pelanggan?" + filter)
        .then(r => r.json())
        .then(d => d.records && d.records[0] ? d.records[0].id : null)
        .then(id => {
          // if found, refresh the pelanggan select and set it
          if (id) {
            return loadPelanggan().then(()=>{
              const sel = document.getElementById('pelanggan');
              if (sel) sel.value = id;
              // notify user
              alert('Pelanggan berhasil dibuat.');
              return id;
            });
          }
          return null;
        });
    }
    // if we have newId, refresh pelanggan select and set it
    return loadPelanggan().then(()=>{
      const sel = document.getElementById('pelanggan');
      if (sel && newId) sel.value = newId;
      // notify user
      alert('Pelanggan berhasil dibuat.');
      return newId;
    });
  });
}

function simpanTransaksi() {
  if (cart.length === 0) return alert("Keranjang kosong!");

  // total as number (without formatting)
  let total = Math.round(cart.reduce((s, i) => s + i.subtotal, 0));

  createPelangganIfNeeded()
    .then(id_pelanggan => {
      return fetch(API + "/transaksi", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          // use local datetime to avoid UTC shift causing date to appear on previous day
          tanggal: formatLocalDatetime(),
          id_pelanggan: id_pelanggan,
          total: total
        })
      });
    })
    .then(res => res.json())
    .then(id_transaksi => {
      const promises = cart.map(item => {
        return fetch(API + "/detail_transaksi", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            id_transaksi: id_transaksi,
            id_produk: item.id_produk,
            qty: item.qty,
            harga: item.harga,
            subtotal: item.subtotal
          })
        }).then(() => {
          return fetch(API + "/produk/" + item.id_produk, {
            method: "PUT",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ stok: item.stok - item.qty })
          });
        });
      });

      return Promise.all(promises).then(() => id_transaksi);
    })
    .then(id_transaksi => {
      alert("âœ… Transaksi Berhasil!");
      // clear and refresh
      cart = [];
      renderCart();
      loadProduk();
      // clear new customer fields and reload pelanggan list
      if (document.getElementById('pelanggan_baru')) document.getElementById('pelanggan_baru').value = '';
      if (document.getElementById('pelanggan_alamat')) document.getElementById('pelanggan_alamat').value = '';
      if (document.getElementById('pelanggan_nohp')) document.getElementById('pelanggan_nohp').value = '';
      loadPelanggan();
    })
    .catch(err => {
      console.error(err);
      alert('Gagal menyimpan transaksi');
    });
}

loadProduk();
loadPelanggan();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>